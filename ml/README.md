# CTG Inference Service

Микросервис для онлайн-инференса кардиотокографических (КТГ) сигналов.
Принимает 5-минутное окно данных (`bpm` и `uc`), извлекает признаки, прогоняет через модель CatBoost и возвращает вероятность гипоксии, бинарную метку и сигнал тревоги после постобработки.

---

## Структура проекта

```
ml/
├── preprocessing/         # загрузка и очистка сигналов
│   └── loaders.py
├── features/              # извлечение признаков
│   ├── common.py
│   ├── uc_features.py
│   ├── figo_rules.py
│   ├── extra.py
│   └── builder.py
├── inference/             # инференс и постобработка
|   ├── models/                # сохранённые модели
|   |   └── model_v1.cbm
│   ├── core.py            # CTGInference, загрузка модели и predict_from_json
│   └── postprocess.py     # фильтрация сигналов риска
├── api/                   # REST API
│   ├── main.py
│   └── schemas.py
├── configs/               # YAML-конфиги с параметрами
    └── default.yaml
```

---

## REST API

Эндпоинт: `POST /predict`

**Вход:**

```json
{
  "window": {
    "t":   [0, 1, 2, 3, ..., 300],
    "bpm": [142, 143, 141, ...],
    "uc":  [10, 12, 15, ...]
  }
}
```

**Выход:**

```json
{
  "proba": 0.72,
  "label": 1,
  "alert": 1
}
```

* `proba` — вероятность гипоксии,
* `label` — бинарная метка (0/1),
* `alert` — тревога после постобработки.

---

## Конфигурация

Параметры обработки сигналов (частота дискретизации, окна, пороги FIGO и др.) описаны в `configs/default.yaml` и загружаются при старте через `ml/config.py`.

---

## Поток данных

1. Потоковые данные сохраняются в БД.
2. Каждые 5 минут формируется окно и передаётся в сервис в формате JSON.
3. Сервис преобразует окно в признаки (`ml/features`), подаёт их в модель (`ml/inference/core.py`).
4. Вероятность обрабатывается правилами постобработки (`ml/inference/postprocess.py`).
5. Результат сохраняется и отображается на фронтенде.