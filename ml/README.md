# CTG Inference Service

Микросервис для онлайн-инференса кардиотокографических (КТГ) сигналов.
Принимает 5-минутное окно данных (`bpm` и `uc`), извлекает признаки, прогоняет через модель CatBoost и возвращает вероятность гипоксии, бинарную метку, параметры и сигнал тревоги после постобработки.

---

## Структура проекта

```
ml/
├── preprocessing/         # загрузка и очистка сигналов
│   └── loaders.py
├── features/              # извлечение признаков
│   ├── common.py
│   ├── uc_features.py
│   ├── figo_rules.py
│   ├── extra.py
│   └── builder.py
├── inference/             # инференс и постобработка
|   ├── models/                # сохранённые модели
|   |   └── model_v1.cbm
│   ├── core.py            # CTGInference, загрузка модели и predict_from_json
│   └── postprocess.py     # фильтрация сигналов риска
├── api/                   # REST API
│   ├── main.py
│   └── schemas.py
├── configs/               # YAML-конфиги с параметрами
    └── default.yaml
```
## Планировщик (окно/шаг)

* **Окно**: 300 с (5 мин) — фиксировано.
* **Шаг инференса (`stride_s`)**: настраиваемый; типичные значения — `1`, `5`, `15` секунд.
* **Горизонт (`H`)**: минуты, по умолчанию `H=5`.

## Предобработка окна

* Ресэмплинг по времени (если `t` нецелочисленный) до 1 Гц, линейная интерполяция пропусков ≤10 с.
* Усечение выбросов: `bpm ∈ [50, 210]`, `uc ∈ [0, 100]`.
* Нормализация фичей — per-window (robust-scaler, медиана/IQR) там, где это нужно модели.

## Модель

* Бустинг (CatBoost) над инженерными фичами по 5,10,15-минутному окну.
* Выдаёт `proba ∈ [0,1]`. В логике ниже применяется гистерезис.

## Постобработка (тревога)

* Порог **включения**: `ALERT_ON = 0.80`
* Порог **снятия**: `ALERT_OFF = 0.60`
* Гистерезис по последнему состоянию: если тревога активна — держим, пока `proba < ALERT_OFF`.
* Доп. правило «разумности»: если `features["valid_ratio"] < 0.9` (много пропусков), тревога не поднимается, метка принудительно `label=0`, но `proba` возвращаем как есть.

## FIGO-индикаторы (из features)

* Ритм: `baseline` → «норма / брадикардия / тахикардия».
* Вариабельность: `stv` и `bpm_sd` → «нормальная / сниженная».
* События: `decels_{early,late,variable,prolonged}`, `accels_count`.
* Дополнительно: `psd_lf_hf`, `poincare_sd1`, `poincare_sd2` — для экспертного экрана.

---

# REST API

## `POST /predict`

**Описание:** разовый инференс по предоставленному окну (без ожидания пополнения БД).

**Вход:**

```json
{
  "window": {
    "t":   [0, 1, 2, 3, ..., 300],
    "bpm": [142, 143, 141, ...],
    "uc":  [10, 12, 15, ...]
  },
  "H": 5
}
```

**Выход:**

```json
{
  "proba": 0.72,
  "label": 1,
  "alert": 1,
  "features": {
    ...
  }
}
```

* `proba` — вероятность гипоксии,
* `label` — бинарная метка (0/1),
* `alert` — тревога после постобработки.
* `features` — признаки модели.

---

## `GET /health`

**Описание:** проверка готовности ML-сервиса и зависимости.

---

## Поток данных

1. Потоковые данные сохраняются в БД.
2. Каждые 5 минут формируется окно и передаётся в сервис в формате JSON.
3. Сервис преобразует окно в признаки (`ml/features`), подаёт их в модель (`ml/inference/core.py`).
4. Вероятность обрабатывается правилами постобработки (`ml/inference/postprocess.py`).
5. Результат сохраняется и отображается на фронтенде.